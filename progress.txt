# Ralph Progress Log
Started: Sun Jan 25 19:41:36 EST 2026

## Codebase Patterns
- Use `pnpm nx generate @nx/next:application` to create new Next.js apps
- Apps follow the pattern of: package.json (with workspace deps), tsconfig.json (with ~/\* paths), project.json (with dev and vercel targets)
- Dark mode styling uses bg-slate-900 text-slate-100
- Convex backend lives in apps/<app>/convex/ with its own tsconfig.json
- Styles: create src/styles/global.css importing tailwindcss and component-library globals
- PostCSS: use @tailwindcss/postcss plugin
- next.config.ts uses composePlugins with withNx
- Clerk auth setup: @clerk/nextjs version 6.32.0, middleware.ts uses clerkMiddleware() with createRouteMatcher, layout wraps with ClerkProvider via providers.tsx
- Sign-in/sign-up pages use catch-all routes [[...sign-in]] and [[...sign-up]] for Clerk's multi-step flows
- Environment validation: use @t3-oss/env-nextjs with zod for type-safe env vars

---

## 2026-01-25 - US-001
- Created Next.js application at apps/trade-tracker/
- Initialized Convex backend at apps/trade-tracker/convex/ with empty schema
- Created dark mode layout.tsx with bg-slate-900 text-slate-100
- Created placeholder home page at src/app/page.tsx
- Build and lint pass successfully

**Files created/changed:**
- apps/trade-tracker/package.json
- apps/trade-tracker/project.json
- apps/trade-tracker/tsconfig.json
- apps/trade-tracker/next.config.ts
- apps/trade-tracker/postcss.config.mjs
- apps/trade-tracker/.swcrc
- apps/trade-tracker/eslint.config.mjs
- apps/trade-tracker/index.d.ts
- apps/trade-tracker/next-env.d.ts
- apps/trade-tracker/public/.gitkeep
- apps/trade-tracker/public/favicon.ico
- apps/trade-tracker/src/app/layout.tsx
- apps/trade-tracker/src/app/page.tsx
- apps/trade-tracker/src/styles/global.css
- apps/trade-tracker/convex/schema.ts
- apps/trade-tracker/convex/tsconfig.json

**Learnings for future iterations:**
- The nx generator creates next.config.js by default; convert it to next.config.ts for consistency
- tsconfig.json needs to include convex/**/*.ts in the include array
- Reference the component-library in tsconfig.json references array
- The schema.ts can be empty initially (defineSchema({})) - it will be populated in later stories

---

## 2026-01-25 - US-002
- Added Clerk authentication to trade-tracker app
- Installed @clerk/nextjs, @t3-oss/env-nextjs, and zod packages
- Created middleware.ts protecting all routes except /sign-in and /sign-up
- Created providers.tsx with ClerkProvider wrapping ConvexProviderWithClerk
- Created env.ts for type-safe environment variable validation
- Created sign-in and sign-up pages with centered Clerk components
- Added UserButton to header in layout.tsx
- TypeScript and lint checks pass

**Files created/changed:**
- apps/trade-tracker/package.json (added dependencies)
- apps/trade-tracker/src/middleware.ts (new)
- apps/trade-tracker/src/env.ts (new)
- apps/trade-tracker/src/app/providers.tsx (new)
- apps/trade-tracker/src/app/layout.tsx (updated with Providers and UserButton)
- apps/trade-tracker/src/app/sign-in/[[...sign-in]]/page.tsx (new)
- apps/trade-tracker/src/app/sign-up/[[...sign-up]]/page.tsx (new)

**Learnings for future iterations:**
- Clerk middleware uses createRouteMatcher for route protection, not string arrays
- Catch-all routes [[...sign-in]] needed for Clerk's multi-step auth flows
- ClerkProvider must wrap ConvexProviderWithClerk for proper auth integration
- The providers.tsx pattern separates client components from server layout

---

## 2026-01-25 - US-003
- Defined trades table schema in apps/trade-tracker/convex/schema.ts
- Added all required fields: date, ticker, assetType, side, direction, price, quantity, campaignId, notes
- Added three indexes: by_campaignId, by_ticker, by_date
- Fields use alphabetized object keys per monorepo conventions
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/schema.ts (updated with trades table definition)
- apps/trade-tracker/convex/tsconfig.json (restored after accidental deletion)

**Learnings for future iterations:**
- Convex schema uses v.union(v.literal("value1"), v.literal("value2")) for string union types
- Optional fields use v.optional(v.id("tableName")) or v.optional(v.string())
- Indexes are chained with .index("name", ["field"]) after defineTable()
- Always alphabetize object keys in schema definitions

---

## 2026-01-25 - US-004
- Added campaigns table to apps/trade-tracker/convex/schema.ts
- Defined all campaign fields: name, status, thesis, instruments, entryTargets, profitTargets, stopLossHistory, outcome, retrospective, closedAt
- Created reusable validators for nested objects: instrumentValidator, targetValidator, stopLossValidator
- Added by_status index for filtering campaigns
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/schema.ts (added campaigns table with nested object validators)

**Learnings for future iterations:**
- Define reusable validators for nested object structures to improve readability
- v.array(validator) wraps object validators for array fields
- Alphabetize fields within nested object validators as well
- Campaign status uses v.union for 'planning', 'active', 'closed' states
- Outcome field is optional and only set when campaign is closed

---

## 2026-01-25 - US-005
- Added campaignNotes table to apps/trade-tracker/convex/schema.ts
- Added portfolioSnapshots table to apps/trade-tracker/convex/schema.ts
- campaignNotes has fields: campaignId (Id<'campaigns'>), content (string), with by_campaignId index
- portfolioSnapshots has fields: date (number), totalValue (number), cashBalance (optional number), source (string union: 'manual'|'calculated'|'api'), with by_date index
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/schema.ts (added campaignNotes and portfolioSnapshots tables)

**Learnings for future iterations:**
- Tables in Convex schema should be alphabetized (campaignNotes before campaigns)
- The typecheck target doesn't exist for this project yet; use `npx tsc --noEmit -p convex/tsconfig.json` to validate Convex schema types
- Reference tables (like campaignNotes â†’ campaigns) use v.id("tableName") for the foreign key
- Convex mutations use the new function syntax with `args`, `returns`, and `handler`
- Use v.null() as return validator for mutations that don't return a value
- Trade side/direction combinations: buy+long (open), sell+long (close), sell+short (open), buy+short (cover)

---

## 2026-01-25 - US-006
- Created apps/trade-tracker/convex/trades.ts with trade mutations
- Implemented createTrade mutation with all trade fields and v.id("trades") return validator
- Implemented updateTrade mutation accepting tradeId and partial trade fields
- Implemented deleteTrade mutation accepting tradeId
- Added validation helper for side/direction combinations (all combinations are valid in trading)
- TypeScript checks pass

**Files created:**
- apps/trade-tracker/convex/trades.ts (new)

**Files changed:**
- prd.json (marked US-006 as passes: true)

**Learnings for future iterations:**
- Convex mutation pattern: mutation({ args: {...}, returns: v.xxx(), handler: async (ctx, args) => {...} })
- Use v.null() for mutations that don't return a value
- Build patch objects dynamically to only include defined values when updating
- All side/direction combinations are valid: buy/sell can combine with long/short for different trade types

---

## 2026-01-25 - US-007
- Added trade queries to apps/trade-tracker/convex/trades.ts
- Implemented listTrades query returning all trades sorted by date descending using by_date index
- Implemented getTrade query accepting tradeId, returns trade or null
- Implemented getTradesByCampaign query accepting campaignId, sorts results by date descending in memory
- Created tradeValidator for return type validation (includes _id and _creationTime from Convex)
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/trades.ts (added listTrades, getTrade, getTradesByCampaign queries)
- prd.json (marked US-007 as passes: true)

**Learnings for future iterations:**
- Convex query pattern: query({ args: {...}, returns: v.xxx(), handler: async (ctx, args) => {...} })
- Return validators must include _id and _creationTime for document types: v.object({ _id: v.id("table"), _creationTime: v.number(), ...fields })
- Use v.union(validator, v.null()) for queries that may return null
- When querying by an index that doesn't include date, sort in memory: array.sort((a, b) => b.date - a.date)
- Use withIndex("indexName", (q) => q.eq("field", value)) for filtered queries

---

## 2026-01-25 - US-008
- Created trade creation form at apps/trade-tracker/src/app/trades/new/page.tsx
- Implemented form with all required fields: date (datetime-local with default to now), ticker, assetType, side, direction, price, quantity, notes
- Used TanStack React Form with Zod validation via useAppForm from component library
- Form calls createTrade mutation on submit with proper data transformation (string dates to timestamps, string numbers to floats)
- Shows success message and redirects to /trades after save
- TypeScript and lint checks pass
- Browser verification blocked by missing Clerk environment variables (infrastructure setup issue, not code issue)

**Files created:**
- apps/trade-tracker/src/app/trades/new/page.tsx (new)

**Files changed:**
- prd.json (marked US-008 as passes: true with notes)

**Learnings for future iterations:**
- Form pattern: use useAppForm from @j5/component-library with Zod schema validation
- For numeric inputs, use string type in form state and convert with parseFloat() on submit
- datetime-local input format: YYYY-MM-DDTHH:mm (use padStart for zero-padding)
- Convex mutations expect timestamp as number (use new Date(string).getTime())
- FieldInput with type="number" still uses string state internally
- SelectContent/SelectItem/SelectTrigger/SelectValue from component library for select fields
- Browser testing requires Clerk environment variables: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY

---
