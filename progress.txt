## Codebase Patterns
- Next.js apps use `@j5/app-name` naming convention in package.json and project.json
- Convex `_generated` folder must be committed (not gitignored) for TypeScript to compile
- Use `pnpm nx format` from root to format code, but may need to use prettier directly on specific files
- Apps are permanently in dark mode - use `text-slate-11`, `text-slate-12` for text colors
- Path alias `~/*` maps to `./src/*` in Next.js apps
- Convex schema uses alphabetized field names and indexes
- ClerkProvider wraps ConvexProviderWithClerk for authentication integration
- `tools/shared` has no project.json - run `npx tsc --noEmit` directly for typecheck

---

## 2026-01-21 - US-001
- **What was implemented**: Created new Next.js app with Convex backend for the Nx Task Coordinator service
- **Files created**:
  - `apps/nx-coordinator/project.json` - Nx project configuration
  - `apps/nx-coordinator/package.json` - Dependencies including Next.js, Convex, Clerk
  - `apps/nx-coordinator/tsconfig.json` - TypeScript configuration with ~/src path alias
  - `apps/nx-coordinator/next.config.ts` - Next.js config with Nx plugin
  - `apps/nx-coordinator/tailwind.config.ts` - Tailwind CSS configuration
  - `apps/nx-coordinator/postcss.config.cjs` - PostCSS configuration
  - `apps/nx-coordinator/src/env.ts` - Environment variable validation with @t3-oss/env-nextjs
  - `apps/nx-coordinator/src/app/layout.tsx` - Root layout with Providers
  - `apps/nx-coordinator/src/app/page.tsx` - Placeholder homepage
  - `apps/nx-coordinator/src/app/Providers.tsx` - Clerk + Convex providers
  - `apps/nx-coordinator/src/styles/global.css` - Global styles importing component library
  - `apps/nx-coordinator/convex/schema.ts` - claimAttempts table with all required indexes
  - `apps/nx-coordinator/convex/auth.config.ts` - Clerk integration for Convex
  - `apps/nx-coordinator/convex/tsconfig.json` - Convex TypeScript config
  - `apps/nx-coordinator/convex/_generated/*` - Generated Convex types
- **Learnings for future iterations:**
  - The Convex _generated files must be created manually when `npx convex dev` isn't available (no deployment URL)
  - Files follow a standard structure that can be copied from other apps in the monorepo
  - Next.js apps don't have an inferred typecheck target from Nx plugins - use `npx tsc --noEmit` directly
  - The `by_gitSha` index was added in addition to the required indexes for future query needs
---

## 2026-01-21 - US-002
- **What was implemented**: Lock acquisition mutation for CI task coordination
- **Files created**:
  - `apps/nx-coordinator/convex/mutations.ts` - `claimTask` mutation
- **Implementation details**:
  - Accepts { project, task, gitSha, agentId } arguments
  - Builds taskKey as `{project}:{task}:{gitSha}`
  - Uses `by_taskKey_and_wasGranted` compound index to check for existing grants
  - Returns `{ acquired: true }` when first to claim
  - Returns `{ acquired: false, claimedBy, claimedAt }` when already claimed
  - Records all attempts (both granted and denied) for analytics
  - Uses native Convex validators with `args` and `returns` for type safety
- **Learnings for future iterations:**
  - Use `v.union()` with `v.literal()` for discriminated union return types in Convex
  - The `as const` assertion helps TypeScript narrow the literal type in return values
  - Convex compound indexes work well for queries needing exact matches on multiple fields
---

## 2026-01-21 - US-003
- **What was implemented**: API route for CI tasks to check in with the coordinator
- **Files created**:
  - `apps/nx-coordinator/src/app/api/claim/route.ts` - POST endpoint for task claims
- **Implementation details**:
  - Created POST /api/claim route accepting JSON body { project, task, gitSha, agentId }
  - Uses `ConvexHttpClient` from 'convex/browser' for server-side mutation calls
  - Returns `{ proceed: true }` when task is acquired
  - Returns `{ proceed: false, message: 'Task already claimed by {agentId}' }` when already claimed
  - Includes validation for required fields with 400 error response
  - Handles errors gracefully with 500 error response
- **Learnings for future iterations:**
  - Use `ConvexHttpClient` from 'convex/browser' for server-side HTTP calls in Next.js API routes
  - The API route imports from relative path `../../../../convex/_generated/api` due to convex folder being outside src
  - Environment variable `NEXT_PUBLIC_CONVEX_URL` is used server-side (public prefix works because it's accessed via process.env)
---

## 2026-01-21 - US-004
- **What was implemented**: Shared check-in utility for Nx executors
- **Files created**:
  - `tools/shared/src/taskCoordinator.ts` - checkInAndProceed function
- **Files modified**:
  - `tools/shared/src/index.ts` - Added export for taskCoordinator
- **Implementation details**:
  - `checkInAndProceed(options: { project, task, gitSha, agentId, coordinatorUrl })` function
  - Makes HTTP POST to coordinator service `/api/claim` endpoint
  - Returns `{ shouldProceed: boolean, message?: string }`
  - Logs decision for CI visibility using descriptive messages
  - Implements retry with exponential backoff (3 attempts with 1s/2s/4s delays) on network errors
  - Throws error after retries exhausted to fail CI
- **Learnings for future iterations:**
  - `tools/shared` doesn't have a project.json, use `npx tsc --noEmit` directly for typecheck
  - Keep exports alphabetically sorted in index.ts
  - Use `isNetworkError()` helper to distinguish retryable errors from non-retryable API errors
---

## 2026-01-21 - US-005
- **What was implemented**: Integration with Doppler for coordinator URL retrieval
- **Files modified**:
  - `tools/shared/src/taskCoordinator.ts` - Updated `CheckInOptions` interface and `checkInAndProceed` function
- **Implementation details**:
  - Changed `checkInAndProceed` to accept `SecretsReader` instead of plain `coordinatorUrl` string
  - Function now extracts `NX_COORDINATOR_URL` from Doppler secrets using `secrets.get("NX_COORDINATOR_URL")`
  - No changes needed to `doppler.ts` - it already fetches all secrets and provides `SecretsReader` interface
  - Updated `CheckInOptions` interface: replaced `coordinatorUrl: string` with `secrets: SecretsReader`
- **Learnings for future iterations:**
  - The `SecretsReader` interface from doppler.ts provides type-safe access to all Doppler secrets
  - Use `secrets.get(keyName)` for string secrets - it throws if the secret is not found
  - The doppler module already fetches all secrets, so new secret keys don't require code changes
---

## 2026-01-21 - US-006
- **What was implemented**: Integrated coordinator check-in into Convex deploy executor
- **Files modified**:
  - `tools/convex/src/executors/deploy/executor.ts` - Added coordinator check-in before deployment
- **Implementation details**:
  - Imported `checkInAndProceed`, `getCurrentCommitSha`, and `os` module
  - Generated `agentId` from `NX_CLOUD_AGENT_ID` env var or fallback to `${os.hostname()}-${process.pid}`
  - Called `getCurrentCommitSha()` to get git SHA
  - Added check-in call after secrets retrieval but before deployment logic
  - Returns early with `{ success: true }` if task already claimed by another agent
  - Continues with normal deployment if task was successfully claimed
  - Alphabetized imports following codebase convention
- **Learnings for future iterations:**
  - The pattern for integrating coordinator into executors is consistent: get project info → check in → early return if not acquired → continue with normal logic
  - Agent ID generation should follow the same pattern across all executors for consistency
  - The coordinator check happens after secrets are retrieved (since checkInAndProceed needs the SecretsReader)
  - Returning `{ success: true }` for skipped tasks ensures CI doesn't fail when a duplicate is blocked
---

## 2026-01-21 - US-007
- **What was implemented**: Integrated coordinator check-in into Vercel deploy executor
- **Files modified**:
  - `tools/vercel/src/executors/build-deploy/executor.ts` - Added coordinator check-in before Vercel deployment
- **Implementation details**:
  - Imported `checkInAndProceed` and `os` module
  - Generated `agentId` from `NX_CLOUD_AGENT_ID` env var or fallback to `${os.hostname()}-${process.pid}` (same pattern as Convex executor)
  - Added check-in call after secrets retrieval but before the Vercel link step
  - Returns early with `{ success: true }` if task already claimed by another agent
  - Continues with normal Vercel deployment logic (link → build → deploy) if task was successfully claimed
  - Alphabetized all imports following codebase convention
- **Learnings for future iterations:**
  - The integration pattern for coordinators is now consistent across both Convex and Vercel executors
  - Both executors now use identical agent ID generation: `process.env.NX_CLOUD_AGENT_ID || ${os.hostname()}-${process.pid}`
  - Task names for coordinator are descriptive: "convex-deploy" and "vercel-build-deploy" to clearly identify which executor is checking in
  - Consolidating imports from `../../../../shared/src/index` helps reduce import statement count and keeps code cleaner
---

## 2026-01-21 - US-008
- **What was implemented**: Created health check endpoint for coordinator service
- **Files created**:
  - `apps/nx-coordinator/convex/queries.ts` - healthCheck query
  - `apps/nx-coordinator/src/app/api/health/route.ts` - GET /api/health endpoint
- **Implementation details**:
  - Created `healthCheck` query in Convex that returns `{ status: "ok", timestamp: Date.now() }`
  - Query has no args and uses validators with `returns` for type safety
  - Created GET endpoint at `/api/health` that calls the Convex health check query
  - Returns `{ status: "healthy", timestamp: Date.now() }` with 200 on success
  - Returns `{ status: "unhealthy", error: errorMessage }` with 503 on failure
  - Uses same ConvexHttpClient pattern as /api/claim endpoint
- **Learnings for future iterations:**
  - When returning literal types in Convex queries, use `as const` assertion to ensure TypeScript narrows the type correctly (e.g., `"ok" as const`)
  - Health check queries should be simple and just verify connectivity - no complex logic needed
  - The 503 status code is appropriate for "Service Unavailable" health check failures
---

## 2026-01-21 - US-009
- **What was implemented**: Added Clerk authentication to protect the coordinator dashboard
- **Files created**:
  - `apps/nx-coordinator/src/middleware.ts` - Clerk middleware with public route configuration
  - `apps/nx-coordinator/src/app/sign-in/[[...sign-in]]/page.tsx` - Sign-in page with centered SignIn component
  - `apps/nx-coordinator/src/app/sign-up/[[...sign-up]]/page.tsx` - Sign-up page with centered SignUp component
- **Implementation details**:
  - Middleware uses `clerkMiddleware()` with `createRouteMatcher()` for public routes
  - Public routes include: /api/claim, /api/health, /sign-in(.*)
, /sign-up(.*) as specified
  - Protected routes require authentication via `await auth.protect()`
  - ClerkProvider was already set up in Providers.tsx from US-001 (wrapping ConvexProviderWithClerk)
  - Sign-in and sign-up pages use catch-all routes `[[...sign-in]]` and `[[...sign-up]]` for Clerk's routing
  - Both auth pages have centered layout with `flex min-h-screen items-center justify-center` and dark mode background
- **Learnings for future iterations:**
  - Clerk middleware requires `createRouteMatcher()` for defining public routes instead of a simple string array
  - The middleware matcher config is standard and should exclude Next.js internals and static files
  - Clerk's SignIn and SignUp components handle all auth UI and flow automatically
  - The `[[...param]]` catch-all route syntax is required for Clerk's multi-step auth flows
---
## 2026-01-21 - US-010
- **What was implemented**: Implemented Convex queries for dashboard analytics
- **Files modified**:
  - `apps/nx-coordinator/convex/queries.ts` - Added three analytics queries
- **Implementation details**:
  - **getRecentAttempts** query with pagination support using Convex's paginate API
    - Accepts optional `limit` (default 50, max 100) and `cursor` parameters
    - Uses `by_attemptedAt` index with descending order
    - Returns `{ attempts, nextCursor }` for pagination
  - **getStats** query for dashboard summary statistics
    - Returns total attempts and 24h counts
    - Returns duplicates blocked overall and last 24h
    - Groups by project and task with total/blocked counts per group
    - Uses in-memory aggregation with Map for grouping
  - **getAttemptsForSha** query to fetch all attempts for a specific Git SHA
    - Uses `by_gitSha` index with descending order by attemptedAt
    - Returns full array of ClaimAttempt documents
  - All queries include full `returns` validators with proper object/array structure
  - Object keys are alphabetically sorted per codebase convention
- **Learnings for future iterations:**
  - Convex's `paginate()` API is the standard way to implement cursor-based pagination on queries
  - The `paginate()` method returns `{ page, continueCursor }` which can be null when no more results
  - For in-memory aggregation in Convex queries, use Map for grouping and Array.from() to convert back
  - Return validators must include system fields like `_id` and `_creationTime` when returning full documents
  - Use `v.union(v.string(), v.null())` for nullable cursor values in pagination
---

## 2026-01-21 - US-011
- **What was implemented**: Created dashboard page with stats cards showing coordination analytics
- **Files created**:
  - `apps/nx-coordinator/src/components/StatsCards.tsx` - Stats cards component with real-time data
- **Files modified**:
  - `apps/nx-coordinator/src/app/page.tsx` - Updated to render full dashboard with header and stats
- **Implementation details**:
  - StatsCards component uses `useQuery(api.queries.getStats)` to subscribe to real-time stats
  - Displays 4 stat cards in responsive grid: Total Claims, Duplicates Blocked, Block Rate (%), Active Projects
  - Loading state shows 4 animated skeleton cards while data loads
  - Card styling matches acceptance criteria: bg-slate-800, border-slate-700, proper text colors (slate-400, slate-100, slate-500)
  - Block Rate calculated as percentage: `(duplicatesBlocked / totalAttempts) * 100`
  - Page includes header with app title and UserButton for sign-out
  - Page uses "use client" directive for Convex real-time subscriptions
  - Full responsive layout with max-w-7xl container and proper padding
- **Learnings for future iterations:**
  - ConvexProviderWithClerk is already set up in Providers.tsx, so client components can directly use `useQuery` hooks
  - Page components that use Convex hooks need "use client" directive at the top
  - Skeleton loading states should match the final layout structure (same number and arrangement of cards)
  - Use `.toLocaleString()` on numbers for better readability (adds thousand separators)
  - UserButton from @clerk/nextjs handles all sign-out UI automatically
  - Without Playwright MCP server, browser verification is limited - recommend manual testing after dev server restart
---

## 2026-01-21 - US-012
- **What was implemented**: Created recent activity table with real-time updates showing all claim attempts
- **Files created**:
  - `apps/nx-coordinator/src/components/ActivityTable.tsx` - Activity table component with real-time subscriptions
- **Files modified**:
  - `apps/nx-coordinator/src/app/page.tsx` - Added ActivityTable below StatsCards with "Recent Activity" heading
- **Implementation details**:
  - ActivityTable uses `useQuery(api.queries.getRecentAttempts, {})` for real-time subscription to claim attempts
  - Table displays 6 columns: Time, Project, Task, Git SHA, Agent, Result
  - Time column uses `formatRelativeTime()` helper: <60s shows "Xs ago", <60m shows "Xm ago", <24h shows "Xh ago", else "Xd ago"
  - Git SHA truncated to first 7 characters with monospace font
  - Result column shows green "Granted" badge (bg-green-900/50 text-green-400) or red "Blocked" badge (bg-red-900/50 text-red-400)
  - Loading state shows 5 animated skeleton rows
  - Empty state shows "No activity yet" message in centered card
  - Table styling matches requirements: bg-slate-800 header, border-b border-slate-800 rows, hover:bg-slate-800/50 on rows
  - Added to page with mt-8 spacing and h2 heading "Recent Activity"
- **Learnings for future iterations:**
  - Real-time subscriptions in Convex automatically update components when data changes
  - Using `attempt._id` as React key ensures proper rendering when new attempts are added
  - Formatting relative timestamps requires handling multiple time units (seconds, minutes, hours, days)
  - Badge components can be inline spans with rounded-full and appropriate padding
  - Empty state handling improves UX when there's no data to display yet
---

## 2026-01-21 - US-013
- **What was implemented**: Created project and task breakdown charts showing claim distribution
- **Files created**:
  - `apps/nx-coordinator/src/components/BreakdownSection.tsx` - Breakdown component with bar charts
- **Files modified**:
  - `apps/nx-coordinator/src/app/page.tsx` - Added stats query and BreakdownSection rendering below activity table
- **Implementation details**:
  - BreakdownSection component accepts `byProject` and `byTask` arrays as props from getStats query
  - Displays two side-by-side sections in grid grid-cols-2 gap-6 layout
  - Each section shows bar list items with: label, "X blocked / Y total" text, progress bar, "XX% blocked" text
  - Progress bar uses h-2 bg-slate-700 container with bg-red-500 fill based on blocked percentage
  - Items sorted by total count descending to show most active projects/tasks first
  - Includes empty state showing "No data yet" when no breakdown data available
  - Page.tsx now fetches stats with useQuery and passes to BreakdownSection (conditional render when stats available)
  - Added section heading "Breakdown by Project and Task" with mt-8 spacing below activity table
- **Learnings for future iterations**:
  - When multiple components need the same data, fetch it in the parent and pass as props to avoid duplicate queries
  - Inline styles are appropriate for dynamic widths (like progress bars) where CSS classes can't express the value
  - The stats query was already providing byProject and byTask arrays, so no backend changes were needed
  - Empty state handling should be done at the component level for reusability
  - toFixed(1) provides clean percentage formatting with one decimal place
---

